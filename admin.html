<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Online Earning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    h2 { color: #0a8; }
    .section { background: white; padding: 15px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    button { margin: 5px; padding: 5px 10px; cursor: pointer; }
    input { margin: 5px 0; padding: 5px; width: 100%; max-width: 300px; }
    .card { padding: 10px; border: 1px solid #ccc; margin-top: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Admin Panel</h2>

  <div class="section">
    <h3>Investment Requests</h3>
    <div id="investmentRequests"></div>
    <button onclick="resetInvestments()" style="background: red; color: white;">Reset</button>
  </div>

  <div class="section">
    <h3>Investment History</h3>
    <div id="investmentHistory"></div>
    <button onclick="resetInvestmentHistory()" style="background: red; color: white;">Reset</button>
  </div>

  <div class="section">
    <h3>Update Investment Methods</h3>
    <form id="updateMethodForm">
       <br>
      <input type="text" placeholder="Method (e.g. Easypaisa)" id="method" required />
      <br>
      <input type="text" placeholder="Number" id="number" required />
      <br>
      <input type="text" placeholder="Account Holder Name" id="name" required />
      <button type="submit">Update Method</button>
    </form>
    <button onclick="resetMethods()" style="background: red; color: white;">Reset</button>
  </div>

  <div class="section">
    <h3>Withdrawal Requests</h3>
    <div id="withdrawalRequests"></div>
    <button onclick="resetWithdrawals()" style="background: red; color: white;">Reset</button>
  </div>

  <div class="section">
    <h3>Withdrawal History</h3>
    <div id="withdrawalHistory"></div>
    <button onclick="resetWithdrawalHistory()" style="background: red; color: white;">Reset</button>
  </div>

  <div class="section">
    <h3>Task Management</h3>
    <form id="taskForm">    
  <input type="text" id="taskTitle" placeholder="Task Title" required />    
  <input type="number" id="taskReward" placeholder="Reward Amount" required />    
  <input type="text" id="taskVideo" placeholder="YouTube Video Link" required />
  <button type="submit">Add Task</button>    
</form>
    <div id="taskList"></div>
    <button onclick="resetTasks()" style="background: red; color: white;">Reset</button>
  </div>

  <div class="section">
    <h3 style="color: red;">Reset All Data</h3>
    <button onclick="resetAllData()" style="background: red; color: white; padding: 10px;">RESET ALL DATA</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getDatabase, ref, onValue, remove, update, set, push, get
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyCe3q7X34_6cwNvUyLZtyXupyHkpQSImts",
    authDomain: "online-earning-pakistan-56617.firebaseapp.com",
    projectId: "online-earning-pakistan-56617",
    storageBucket: "online-earning-pakistan-56617.appspot.com",
    messagingSenderId: "790184224806",
    appId: "1:790184224806:web:1f5064d69be36bf6491ee7"
  });

  const db = getDatabase(app);

  // ✅ Individual Reset Functions
  window.resetInvestments = () => {
    if (confirm("Reset investment requests?")) {
      remove(ref(db, "investments")).then(() => alert("Investment requests reset"));
    }
  };

  window.resetInvestmentHistory = () => {
    if (confirm("Reset investment history?")) {
      remove(ref(db, "investmentHistory")).then(() => alert("Investment history reset"));
    }
  };

  window.resetMethods = () => {
    if (confirm("Reset investment method numbers?")) {
      remove(ref(db, "admin/investmentMethods")).then(() => alert("Investment methods reset"));
    }
  };

  window.resetWithdrawals = () => {
    if (confirm("Reset withdrawal requests?")) {
      remove(ref(db, "withdrawals")).then(() => alert("Withdrawal requests reset"));
    }
  };

  window.resetWithdrawalHistory = () => {
    if (confirm("Reset withdrawal history?")) {
      remove(ref(db, "withdrawalHistory")).then(() => alert("Withdrawal history reset"));
    }
  };

  window.resetTasks = () => {
    if (confirm("Reset all tasks?")) {
      remove(ref(db, "admin/tasks")).then(() => alert("Tasks reset"));
    }
  };

  window.resetAllData = async () => {
    if (!confirm("Are you sure you want to reset all data? This cannot be undone!")) return;

    const pathsToReset = [
      "investments",
      "investmentHistory",
      "withdrawals",
      "withdrawalHistory",
      "admin/investmentMethods",
      "admin/tasks"
    ];

    try {
      for (const path of pathsToReset) {
        await remove(ref(db, path));
      }
      alert("All data reset successfully!");
      location.reload();
    } catch (err) {
      alert("Error resetting data: " + err.message);
    }
  };

  // ✅ Rest of your unchanged code

  const loadInvestments = () => {
    const container = document.getElementById("investmentRequests");
    container.innerHTML = "";
    const investRef = ref(db, "investments");

    onValue(investRef, snapshot => {
      container.innerHTML = "";
      snapshot.forEach(userSnap => {
        const userId = userSnap.key;
        userSnap.forEach(reqSnap => {
          const data = reqSnap.val();
          if (data.status === "pending") {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
              <p><b>Name:</b> ${data.name}</p>
              <p><b>Method:</b> ${data.method}</p>
              <p><b>Number:</b> ${data.number}</p>
              <p><b>Amount:</b> ${data.amount}</p>
              <p><b>TRX ID:</b> ${data.trxId}</p>
              <button onclick="approveInvestment('${userId}', '${reqSnap.key}', ${data.amount})">Approve</button>
              <button onclick="rejectInvestment('${userId}', '${reqSnap.key}')">Reject</button>
            `;
            container.appendChild(div);
          }
        });
      });
    });
  };

  window.approveInvestment = async (uid, id, amount) => {
    const requestRef = ref(db, `investments/${uid}/${id}`);
    await update(requestRef, { status: "approved" });
    await update(ref(db, `users/${uid}`), {
      investmentStatus: "approved",
      balance: 30
    });

    const historyRef = push(ref(db, `investmentHistory/${uid}`));
    await set(historyRef, {
      status: "approved",
      amount,
      timestamp: Date.now()
    });

    const userSnap = await get(ref(db, `users/${uid}`));
    const userData = userSnap.val();
    if (userData && userData.referrerUid) {
      const referrerUid = userData.referrerUid;
      const reward = amount * 0.4;

      const referrerSnap = await get(ref(db, `users/${referrerUid}/referralEarning`));
      const current = referrerSnap.exists() ? referrerSnap.val() : 0;

      await update(ref(db, `users/${referrerUid}`), {
        referralEarning: current + reward
      });

      await set(ref(db, `referrals/${referrerUid}/${Date.now()}`), {
        referredUid: uid,
        rewardAmount: reward,
        investmentAmount: amount,
        status: "approved",
        time: new Date().toISOString()
      });
    }
  };

  window.rejectInvestment = (uid, id) => {
    const requestRef = ref(db, `investments/${uid}/${id}`);
    update(requestRef, { status: "rejected" });
    const historyRef = push(ref(db, `investmentHistory/${uid}`));
    set(historyRef, {
      status: "rejected",
      timestamp: Date.now()
    });
  };

  document.getElementById("updateMethodForm").addEventListener("submit", e => {
    e.preventDefault();
    const method = document.getElementById("method").value;
    const number = document.getElementById("number").value;
    const name = document.getElementById("name").value;

    const methodRef = ref(db, "admin/investmentMethods/" + method.toLowerCase());
    set(methodRef, {
      method,
      number,
      name
    });
    alert("Updated");
  });

  const loadWithdrawals = () => {
    const container = document.getElementById("withdrawalRequests");
    const refW = ref(db, "withdrawals");
    onValue(refW, snapshot => {
      container.innerHTML = "";
      snapshot.forEach(userSnap => {
        const uid = userSnap.key;
        userSnap.forEach(reqSnap => {
          const data = reqSnap.val();
          if (data.status === "pending") {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
  <p><b>Name:</b> ${data.name || "N/A"}</p>
  <p><b>Method:</b> ${data.method || "N/A"}</p>
  <p><b>Number:</b> ${data.number}</p>
  <p><b>Amount:</b> ${data.amount}</p>
  <button onclick="approveWithdraw('${uid}', '${reqSnap.key}', ${data.amount})">Approve</button>
  <button onclick="rejectWithdraw('${uid}', '${reqSnap.key}')">Reject</button>
`;
            container.appendChild(div);
          }
        });
      });
    });
  };

  window.approveWithdraw = async (uid, id, amount) => {
    await update(ref(db, `withdrawals/${uid}/${id}`), { status: "approved" });

    const userRef = ref(db, `users/${uid}`);
    const userSnap = await get(userRef);

    if (userSnap.exists()) {
      let data = userSnap.val();
      let balance = parseInt(data.balance || 0);
      let referral = parseInt(data.referralEarning || 0);
      let amt = parseInt(amount);

      if (referral >= amt) {
        referral -= amt;
      } else {
        amt -= referral;
        referral = 0;
        balance = balance - amt;
      }

      await update(userRef, {
        balance: balance < 0 ? 0 : balance,
        referralEarning: referral < 0 ? 0 : referral
      });
    }

    const hist = push(ref(db, `withdrawalHistory/${uid}`));
    set(hist, {
      amount,
      status: "approved",
      timestamp: Date.now()
    });
  };

  window.rejectWithdraw = (uid, id) => {
    update(ref(db, `withdrawals/${uid}/${id}`), { status: "rejected" });
    const hist = push(ref(db, `withdrawalHistory/${uid}`));
    set(hist, {
      status: "rejected",
      timestamp: Date.now()
    });
  };

  const loadHistory = () => {
    const investHist = document.getElementById("investmentHistory");
    const withHist = document.getElementById("withdrawalHistory");

    onValue(ref(db, "investmentHistory"), snap => {
      investHist.innerHTML = "";
      snap.forEach(userSnap => {
        userSnap.forEach(entry => {
          const data = entry.val();
          investHist.innerHTML += `<div class="card">Status: ${data.status}, Amount: ${data.amount || "-"}, Time: ${new Date(data.timestamp).toLocaleString()}</div>`;
        });
      });
    });

    onValue(ref(db, "withdrawalHistory"), snap => {
      withHist.innerHTML = "";
      snap.forEach(userSnap => {
        userSnap.forEach(entry => {
          const data = entry.val();
          withHist.innerHTML += `<div class="card">Status: ${data.status}, Amount: ${data.amount || "-"}, Time: ${new Date(data.timestamp).toLocaleString()}</div>`;
        });
      });
    });
  };

  document.getElementById("taskForm").addEventListener("submit", e => {
  e.preventDefault();

  const title = document.getElementById("taskTitle").value;
  const reward = parseInt(document.getElementById("taskReward").value);
  const videoUrl = document.getElementById("taskVideo").value;

  if (!title || isNaN(reward) || !videoUrl) return alert("Invalid input");

  const taskRef = push(ref(db, "admin/tasks"));
  set(taskRef, {
    title,
    reward,
    videoUrl
  }).then(() => {
    document.getElementById("taskForm").reset();
    alert("Task added!");
  });
});

  
  const loadTasks = () => {
    const list = document.getElementById("taskList");
    const tasksRef = ref(db, "admin/tasks");
    onValue(tasksRef, snap => {
      list.innerHTML = "";
      snap.forEach(taskSnap => {
        const data = taskSnap.val();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <p><b>Title:</b> ${data.title}</p>
          <p><b>Reward:</b> ${data.reward}</p>
          <button onclick="deleteTask('${taskSnap.key}')">Delete</button>
        `;
        list.appendChild(div);
      });
    });
  };

  window.deleteTask = (taskId) => {
    const taskRef = ref(db, `admin/tasks/${taskId}`);
    remove(taskRef).then(() => alert("Task deleted"));
  };

  // 🔁 Initial load
  loadInvestments();
  loadWithdrawals();
  loadHistory();
  loadTasks();
</script>

</body>
</html>